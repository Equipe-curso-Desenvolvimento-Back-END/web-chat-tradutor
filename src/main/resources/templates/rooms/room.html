<html>
    <!-- <input type="hidden" id="roomId" th:value="${room.id}" /> -->
    <!-- CARREGANDO Libs -->
    <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script> 
</head>
<body>
    <!-- Carregamento de captura do room.id -->
    <input type="hidden" id="roomId" th:value="${room.id}" />

        <p>

    <!-- Nao mais necessario pois pegaos o nick name real -->
    <!-- <input type="text" id="nickname-input" value="Visitante" placeholder="Seu nome" /> -->
    <input type="hidden" id="nickname-data" th:value="${userName}" />
        </p>

        <!-- Botao de sair -->
        <button onclick="exitRoom()">Sair da Sala</button>

        <!-- chat box das mensagens -->
        <div id="chat-output" style="height: 300px; border: 1px solid #ccc; overflow-y: scroll; margin-top: 10px;">
            </div>

            <!-- Input do usuario -->
        <input type="text" id="message-input" placeholder="Digite sua mensagem" style="width: 70%;" />
                 <!-- Botao de enviar mensagem -->
        <button onclick="sendMessage()">Enviar</button>

<script>
    // GLOBAIS
    let stompClient = null;
    
        // 2. FUN√á√ÉO PRINCIPAL QUE INICIA TUDO
    function connect() {
        // üîë SOLU√á√ÉO DO TypeError: Lemos o ID APENAS AQUI, dentro da fun√ß√£o de conex√£o.
        // Se o elemento n√£o for encontrado no DOM, o ROOM_ID ser√° null e o if impedir√° a falha.
        const roomIdElement = document.getElementById('roomId');
        
        if (!roomIdElement) {
            console.error("ERRO CR√çTICO: Elemento 'roomId' n√£o encontrado. Verifique seu HTML.");
            return;
        }

        const ROOM_ID = roomIdElement.value;
        const socket = new SockJS('/ws'); 
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('>>> CONECTADO AO WEBSOCKET');

            // Assina o t√≥pico
            stompClient.subscribe('/topic/room/' + ROOM_ID, function (messageOutput) {
                showMessage(messageOutput.body);
            });
        }, function(error) {
            console.error('Erro de conex√£o do STOMP:', error);
            alert('Whoops! Lost connection to http://localhost:8080/ws');
        });
    }

    function exitRoom() {
        if (stompClient && stompClient.connected) {
            stompClient.disconnect(function() {
                console.log("Desconectado da sala.");
                window.location.href = "/rooms"; // Redireciona para a lista de salas
            });
        }
    }

    // 3. FUN√á√ÉO DE ENVIO DE MENSAGEM (Resolvendo messageInput is not defined)
    function sendMessage() {
        // Acesso local aos elementos para evitar ReferenceError
        const messageInput = document.getElementById('message-input');
        // nickname-input virou nickname-data
        const nicknameInput = document.getElementById('nickname-data');
        const roomIdElement = document.getElementById('roomId');

        if (!stompClient || !stompClient.connected) {
            console.warn('Conex√£o STOMP n√£o estabelecida.');
            return;
        }

        if (!messageInput || !nicknameInput || !roomIdElement) {
            console.error("Erro: Campos de input n√£o encontrados para envio.");
            return;
        }
        
        const content = messageInput.value.trim();
        const senderName = nicknameInput.value.trim();
        const ROOM_ID = roomIdElement.value; // Pega o ID da sala novamente

        if (content && senderName) {
            const chatMessage = {
                senderName: senderName,
                content: content,
                roomId: ROOM_ID
            };

            stompClient.send("/app/room/" + ROOM_ID, {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    function showMessage(messageString) { 
        try {
            const messageObject = JSON.parse(messageString);
            
            const output = document.getElementById('chat-output');
            const messageElement = document.createElement('div');
            
            messageElement.innerHTML = `<strong>${messageObject.senderName}:</strong> <span>${messageObject.content}</span>`;
            
            output.appendChild(messageElement);
            output.scrollTop = output.scrollHeight; 
            
        } catch (e) {
            console.error("Erro ao processar mensagem JSON:", e, messageString);
        }
    }

    // INICIALIZADOR DO DOM 
    window.onload = connect;

</script>
</body>
</html>